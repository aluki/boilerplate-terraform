# https://taskfile.dev

version: '3'

tasks:

  default:
    cmds:
      - task -l
    silent: true

  init:
    desc: Initialises the project
    sources:
      - mise.toml
    generates:
      - mise.lock
    cmds:
      - mise install

  tf_init:
    desc: Initialises the Terraform project
    deps:
      - init
    sources:
      - versions.tf
    generates:
      - .terraform.lock.hcl
    cmds:
      - tofu init

  tf_plan:
    desc: Plans the project
    deps:
      - tf_init
    cmds:
      - tofu plan

  tf_apply:
    desc: Applies the project
    deps:
      - tf_init
    cmds:
      - tofu apply -auto-approve

  tf_destroy:
    desc: Destroys the project
    deps:
      - tf_init
    cmds:
      - tofu destroy -auto-approve

  tf_validate:
    desc: Validates the Terraform project
    deps:
      - tf_init
    sources:
      - "*.tf"
      - .terraform.lock.hcl
    cmds:
      - tofu validate

  test:
    desc: Test the project
    deps:
      - tf_validate
    sources:
      - "*.tf"
      - .terraform.lock.hcl
      - "*.tftest.hcl"
      - "*.tftest.json"
      - "*.tofutest.hcl"
      - "*.tofutest.json"
      - "tests/*.tftest.hcl"
      - "tests/*.tftest.json"
      - "tests/*.tofutest.hcl"
      - "tests/*.tofutest.json"
    cmds:
      - tofu test
